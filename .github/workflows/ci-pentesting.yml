name: CI/CD with Pentesting (Nuclei + Trivy)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 943918156523.dkr.ecr.us-east-1.amazonaws.com
  ECR_REPO: wp-demo
  IMAGE_TAG: latest

jobs:
  build-push-sast:
    name: Build, Push & Trivy SAST
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        run: |
          docker build -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }} .
          
      - name: Push to ECR
        run: |
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}

      - name: Trivy Image Scan (SAST)
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH,MEDIUM
          exit-code: '0'

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
          category: 'Trivy Container Scan'

      - name: Generate Trivy HTML Report
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --format template --template '@contrib/html.tpl' \
            -o trivy-report.html \
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}

      - name: Upload Trivy Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.html
          retention-days: 30

  nuclei-dast:
    name: Nuclei Pentesting (DAST)
    runs-on: ubuntu-latest
    needs: build-push-sast
    if: success()
    
    steps:
      - name: Nuclei DAST Scan
        uses: projectdiscovery/nuclei-action@v1.0.0
        with:
          target: 'http://${{ secrets.SITE_URL }}'
          templates: 'http,network,dns,file,headless'
          severity: 'critical,high,medium'
          json: true
          output: 'nuclei-report.json'

      - name: Parse Nuclei Results
        id: nuclei-parse
        run: |
          if [ -f nuclei-report.json ]; then
            CRITICAL=$(cat nuclei-report.json | grep -c '"severity":"critical"' || echo "0")
            HIGH=$(cat nuclei-report.json | grep -c '"severity":"high"' || echo "0")
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "## Nuclei Pentesting Results" >> $GITHUB_STEP_SUMMARY
            echo "- Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- High: $HIGH" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Nuclei Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuclei-report
          path: nuclei-report.json
          retention-days: 30

  update-container:
    name: Refresh Container with Watchtower
    runs-on: self-hosted
    needs: build-push-sast
    
    steps:
      - name: Trigger Watchtower Update
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            containrrr/watchtower \
            --run-once wordpress-ci_wordpress_1

      - name: Verify Container Update
        run: |
          docker exec wordpress-ci_wordpress_1 cat /build-info.txt || echo "Container updated"
